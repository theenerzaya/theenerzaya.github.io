(window.webpackJsonp=window.webpackJsonp||[]).push([["financial-times-o-errors"],{"28e82b7d":function(t,r,e){"use strict";e.r(r),e.d(r,"errors",(function(){return c}));var n=e("7fae31e6"),o=e.n(n);function i(t,r){this._logBuffer=new Array(t),this._nextLogIndex=0,this._logLevel=i.level[r],this.enabled=this._logLevel!==i.level.off,this.enabled||(this._consoleLog=s);const e="undefined"!=typeof console?console:{log:s,warn:s,error:s};this.out=e}function s(){}i.prototype.error=function(){this._consoleLog("ERROR",this.out.error,arguments)},i.prototype.log=function(){this._consoleLog("LOG",this.out.log,arguments)},i.prototype.warn=function(){this._consoleLog("WARN",this.out.warn,arguments)},i.prototype._consoleLog=function(t,r,e){const n=this._logLevel===i.level.debug||this._logLevel===i.level.consoleonly,o=function(t,r){let e=t+":";for(let t=0;t<r.length;t++)e+=" "+r[t];return e}(t,e);this.append(o),n&&r&&r.apply(this.out,e)},i.prototype.append=function(t){this._logBuffer[this._nextLogIndex]=t,this._nextLogIndex++,this._nextLogIndex===this._logBuffer.length&&(this._nextLogIndex=0)},i.prototype.logLines=function(){let t=this._nextLogIndex;const r=this._nextLogIndex,e=[];do{void 0!==this._logBuffer[t]&&e.push(this._logBuffer[t]),t++,t>=this._logBuffer.length&&(t=0)}while(t!==r);return e.join("\n")},i.level={off:0,contextonly:1,debug:2,consoleonly:3};var l=i;function a(t){return"function"==typeof t}function f(t){setTimeout((function(){throw t}),0)}function u(){this.ravenClient=null,this.initialised=!1,this.logger=null,this._logEventHandler=this.handleLogEvent.bind(this),this._errorBuffer=[],this._declarativeConfigString=!1,this._filterError=function(){return!0},this._transformError=function(t){return t}}u.prototype.init=function(t,r){if(this.initialised)return this;const e=this._hasDeclarativeConfig();if(!(e||t))return this;t=t||{},e&&((t=this._initialiseDeclaratively(t)).filterError&&(t.filterError=void 0,f(new Error("Can not configure 'oErrors' with `filterError` using declarative markup - error filtering will not be enabled"))),t.transformError&&(t.transformError=void 0,f(new Error("Can not configure 'oErrors' with `transformError` using declarative markup - error transforming will not be enabled"))),t.transportFunction&&(t.transportFunction=void 0,f(new Error("Can not configure 'oErrors' with `transportFunction` using declarative markup - overriding Sentry's transport function will not be enabled")))),a(t.transformError)&&(this._transformError=t.transformError),a(t.filterError)&&(this._filterError=t.filterError),Array.isArray(t.errorBuffer)&&t.errorBuffer.length>0&&(this._errorBuffer=this._errorBuffer.concat(t.errorBuffer));const n=void 0!==t.enabled&&!1===t.enabled,o=n?l.off:t.logLevel;if(this.logger=new l(10,o),n)return this.report=function(t){return t},this.wrapWithContext=function(t,r){return r},this.initialised=!0,this;if(!t.sentryEndpoint)throw new Error("Could not initialise o-errors: Sentry endpoint and auth configuration missing.");if(l.level[o]!==l.level.consoleonly)this._configureAndInstallRaven(t,r);else{const t=this.logger;this.ravenClient={captureException:function(){return t.error(arguments)},uninstall:function(){}}}return document.addEventListener("oErrors.log",this._logEventHandler),this.initialised=!0,this._flushBufferedErrors(),this},u.prototype._configureAndInstallRaven=function(t,r){r||this.ravenClient||(r=o.a),this.ravenClient=r;const e=t.sentryEndpoint,n={dataCallback:this._updatePayloadBeforeSend.bind(this)};t.siteVersion&&(n.release=t.siteVersion),t.environment&&(n.environment=t.environment),t.tags&&(n.tags=t.tags),a(t.filterError)&&(n.shouldSendCallback=t.filterError),a(t.transportFunction)&&(n.transport=t.transportFunction),this.ravenClient.config(e,n),this.ravenClient.install()},u.prototype._flushBufferedErrors=function(){if(!this.initialised)return;const t=this;this._errorBuffer.forEach((function(r){t.report(r.error,r.context)})),this._errorBuffer=[]},u.prototype.report=function(t,r){let e={error:t,context:{extra:r||{}}};if(!this.initialised)return this._errorBuffer.push(e),t;const n=this._transformError(e);return n&&n.error&&(e=n),e.context||(e.context={}),this._filterError(e)?(e.error.message&&(e.context.errormessage=e.error.message),this.ravenClient.captureException(e.error,e.context),t):t},u.prototype.error=function(){this.logger.error.apply(this.logger,arguments)},u.prototype.warn=function(){this.logger.warn.apply(this.logger,arguments)},u.prototype.log=function(){this.logger.log.apply(this.logger,arguments)},u.prototype.wrap=function(t){return this.wrapWithContext({},t)},u.prototype.wrapWithContext=function(t,r){const e=this;return function(){try{return r.apply(void 0,arguments)}catch(r){throw e.report(r,t),r}}},u.prototype.destroy=function(){this.initialised&&(document.removeEventListener("oErrors.log",this._logEventHandler),this.ravenClient.uninstall())},u.prototype.handleLogEvent=function(t){if(!t)return;const r={info:t.detail.info||{},extra:{"context:dom":this._getEventPath(t).reduceRight((function(t,r){const e=Array.prototype.slice.call(r.classList||[]);if(!r.nodeName)return t+" - "+r.constructor.name+"\n";const n=r.nodeName.toLowerCase();return 0===n.indexOf("#")?t+"<"+n+">\n":t+"<"+r.nodeName.toLowerCase()+" class='"+e.join(" ")+"' id='"+(r.id||"")+"'>\n"}),"")}};this.report(t.detail.error,r)},u.prototype._getEventPath=function(t){const r=[];let e=t.target||window.event.srcElement;for(;e;)r.push(e),e=e.parentElement;return r},u.prototype._updatePayloadBeforeSend=function(t){return this.logger.enabled&&(t.extra["context:log"]=this.logger.logLines()),t},u.prototype._hasDeclarativeConfig=function(){return Boolean(this._getDeclarativeConfig())},u.prototype._getDeclarativeConfig=function(){if(!this._declarativeConfigString){const t=document.querySelector("script[data-o-errors-config]");if(!t)return!1;this._declarativeConfigString=t.textContent||t.innerText||t.innerHTML}return this._declarativeConfigString},u.prototype._initialiseDeclaratively=function(t){if(!this._hasDeclarativeConfig())return!1;let r;try{r=JSON.parse(this._getDeclarativeConfig())}catch(t){throw new Error("Invalid JSON configuration syntax, check validity for o-errors configuration: '"+t.message+"'")}for(const e in r)r.hasOwnProperty(e)&&(t[e]=t[e]||r[e]);return this._declarativeConfigString=!1,t};const c=new u;"undefined"!=typeof document&&document.addEventListener("o.DOMContentLoaded",(function t(){c.init(),document.removeEventListener("o.DOMContentLoaded",t)}));r.default=c}}]);
//# sourceMappingURL=financial-times-o-errors.1dd394cbd297.bundle.js.map