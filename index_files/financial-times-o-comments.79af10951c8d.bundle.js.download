(window.webpackJsonp=window.webpackJsonp||[]).push([["financial-times-o-comments"],{e2efd6c7:function(t,e,n){"use strict";n.r(e);var o={coralEventMap:new Map([["ready",{oComments:"oComments.ready",oTracking:"ready"}],["loginPrompt",{oComments:"oComments.loginPrompt"}],["createComment.success",{oComments:"oComments.postComment",oTracking:"post"}],["createComment.error",{oComments:"oComments.errorComment",oTracking:"post-error"}],["createCommentReply.success",{oComments:"oComments.replyComment",oTracking:"reply"}],["editComment.success",{oComments:"oComments.editComment",oTracking:"edit"}],["createCommentReaction.success",{oComments:"oComments.likeComment",oTracking:"like"}],["reportComment.success",{oComments:"oComments.reportComment",oTracking:"report"}],["ignoreUser.success",{oComments:"oComments.ignoreUser",oTracking:"ignore-user"}]])},s=n("15baad73");const i=t=>new Promise((e,n)=>{if(!t)return n(new Error("Empty display name"));const o=(t=>{const e=t.match(/[^0-9a-z!#$%'`()*+,\-.\/:;=@[\]\^_{}\|\s]/gi),n=e&&e.length?e.filter((t,n)=>e.indexOf(t)===n):[];return!!n.length&&n.join("")})(t);if(o)return n(new Error("The display name contains the following invalid characters: "+o));(t=>{const e="https://comments-api.ft.com/displayname/isavailable/"+encodeURIComponent(t);return fetch(e,{method:"GET"}).then(t=>t.json()).then(t=>{let{available:e}=t;return e})})(t).then(o=>o?e(t):n(new Error("Unfortunately that display name is already taken"))).catch(()=>{const t=new Error("Sorry, we are unable to update display names. Please try again later.");return t.name="CommentsApiError",n(t)})});var a=()=>{const t=new s.default("displayName",{html:'<form id="o-comments-displayname-form" class="o-forms o-forms o-comments__displayname-form">\n\t\t\t<label for="o-comments-displayname-input" class="o-forms-field o-comments__displayname-field">\n\t\t\t\t<span class="o-forms-title">Display name</span>\n\t\t\t</label>\n\t\t\t<div class="o-comments__displayname-container">\n\t\t\t\t<span class="o-forms-input o-forms-input--text o-comments__displayname-input">\n\t\t\t\t\t<input id="o-comments-displayname-input" type="text" name="text" value="" required="">\n\t\t\t\t</span>\n\t\t\t\t<button type="submit" class="o-comments__displayname-submit">Save</button>\n\t\t\t</div>\n\t\t\t<span id="o-comments-displayname-error" class="o-forms-input__error o-comments__displayname-error" aria-live="assertive"></span>\n\t</form>\n</form>',class:"o-comments__displayname-prompt",compact:!0,heading:{title:"Choose a commenting display name"}});return t.open(),t},r=i,m=t=>(t.preventDefault(),new Promise(e=>{const n=t.srcElement,o=n.querySelector("input").value.trim(),s=n.querySelector("#o-comments-displayname-error");return s.innerText="",n.classList.remove("o-forms-input--invalid"),i(o).then(t=>e(t)).catch(t=>{if(s.innerText=t.message,n.classList.add("o-forms-input--invalid"),"CommentsApiError"===t.name)throw t})})),c=function(){let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=new URL("https://comments-api.ft.com/user/auth/");return t.displayName&&e.searchParams.append("displayName",t.displayName),t.useStagingEnvironment&&e.searchParams.append("staging","1"),fetch(e,{credentials:"include"}).then(t=>t.ok?t.json():409===t.status?{userHasValidSession:!0}:{userHasValidSession:!1})};var l=class{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.streamEl=t||document,this.options=e,this.eventSeenTimes={},this.useStagingEnvironment=Boolean(e.useStagingEnvironment)}init(){const t=t=>Promise.all([this.renderComments(),this.authenticateUser(t)]).then(()=>{this.login()});return r(this.options.displayName).then(e=>t(e)).catch(()=>t())}login(){this.authenticationToken&&(this.embed.login(this.authenticationToken),this.displayName&&this.renderSignedInMessage())}authenticateUser(t){const e={useStagingEnvironment:this.useStagingEnvironment};return t&&(e.displayName=t),c(e).then(t=>{this.displayName=t.displayName,t.token?this.authenticationToken=t.token:this.userHasValidSession=t.userHasValidSession}).catch(()=>!1)}renderComments(){return new Promise(t=>{try{const e="cachebust=20210806",n=this.useStagingEnvironment?"https://ft.staging.coral.coralproject.net":"https://ft.coral.coralproject.net",o=document.createElement("script");if(o.src=`${n}/assets/js/embed.js?${e}`,o.onload=()=>{this.embed=Coral.createStreamEmbed({id:this.streamEl.id,storyURL:this.options.articleUrl,storyID:this.options.articleId,rootURL:n,autoRender:!0,bodyClassName:"o-comments-coral-talk-container",events:t=>{t.onAny((t,e)=>{this.publishEvent({name:t,data:e})})}}),t()},this.streamEl.parentNode.appendChild(o),this.useStagingEnvironment){const t=document.createElement("div");t.innerHTML='\n\t\t\t\t\t\t\t\t\t\t\t<div class="o-comments__staging-message-container">\n\t\t\t\t\t\t\t\t\t\t\t\t<div class="o-comments__staging-message-content">\n\t\t\t\t\t\t\t\t\t\t\t\t\t<p class="o-comments__staging-message">You are on the staging environment for Comments</p>\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t\t\t</div>',this.streamEl.parentNode.insertBefore(t,this.streamEl)}document.dispatchEvent(new Event("oCommentsReady"))}catch(e){t()}})}displayNamePrompt(){let{purgeCacheAfterCompletion:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const e=a(),n=n=>{const o=n.srcElement.querySelector("#o-comments-displayname-form");o&&o.addEventListener("submit",n=>{m(n).then(n=>{e.close(),this.authenticateUser(n).then(()=>{this.login()}),t&&fetch("https://comments-api.ft.com/user/auth",{method:"PURGE",credentials:"include"})})})};document.addEventListener("oOverlay.ready",n);const o=()=>{e.context.removeEventListener("oLayers.close",o),document.removeEventListener("oOverlay.ready",n),e.destroy()};e.context.addEventListener("oLayers.close",o)}publishEvent(t){let{name:e,data:n={}}=t;const{success:{status:s}={},error:i}=n;if("loginPrompt"===e&&this.userHasValidSession)return this.displayNamePrompt();const a=o.coralEventMap.get(e);if(a){const t=Number(new Date),e=100;if(!this.eventSeenTimes[a.oComments]||t>this.eventSeenTimes[a.oComments]+e){this.eventSeenTimes[a.oComments]=t;const e={bubbles:!0};i&&(e.detail={error:i});const n=new CustomEvent(a.oComments,e);if(this.streamEl.dispatchEvent(n),a.oTracking&&!this.options.disableOTracking){const t={bubbles:!0,detail:{category:"comment",action:a.oTracking,coral:!0,isWithheld:"SYSTEM_WITHHELD"===s}};i&&(t.detail.error=i);const e=new CustomEvent("oTracking.event",t);document.body.dispatchEvent(e)}}}}renderSignedInMessage(){const t="o-comments-edit-button--"+this.streamEl.id,e=document.createElement("div");e.classList.add("o-comments__signed-in-container"),e.innerHTML=`\n\t\t\t\t\t\t\t\t\t<p class="o-comments__signed-in-text">Signed in as\n\t\t\t\t\t\t\t\t\t\t<span class="o-comments__signed-in-inner-text"></span>\n\t\t\t\t\t\t\t\t\t\t<button id="${t}" class="o-comments__edit-display-name">\n\t\t\t\t\t\t\t\t\t\t\tEdit <span class="o-comments__edit-display-name-descriptive">commenting display name</span>\n\t\t\t\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t\t\t\t</p>`,e.querySelector(".o-comments__signed-in-inner-text").innerText=this.displayName;const n=this.streamEl.parentNode.querySelector(".o-comments__signed-in-container");n&&n.remove(),this.streamEl.parentNode.insertBefore(e,this.streamEl),document.getElementById(t).onclick=()=>{this.displayNamePrompt({purgeCacheAfterCompletion:!0})}}};class d{constructor(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.countEl=t,this.articleId=e.articleId,this.useStagingEnvironment=Boolean(e.useStagingEnvironment)}renderCount(){if(!this.countEl||this.countEl instanceof HTMLElement||(this.countEl=document.querySelector(this.countEl)),!this.countEl)throw new Error("Element must be a HTMLElement");return d.fetchCount(this.articleId,this.useStagingEnvironment).then(t=>{this.countEl.textContent=t;const e=d.getCountLabel(t);this.countEl.setAttribute("aria-label",e)})}static getCountLabel(t){return 1===t?"There is 1 comment, click to go to the comment section.":`There are ${t} comments, click to go to the comment section.`}static fetchCount(t,e){return fetch("https://comments-api.ft.com/story/count/"+t+(e?"?staging=1":"")).then(t=>t.json()).then(t=>t.commentCount).catch(t=>{throw new Error("Error with fetching comment count: "+t.message)})}}var u=d;class p{constructor(t,e){this.options=Object.assign({},{},e||p.getDataAttributes(t));const n="true"===t.getAttribute("data-o-comments-count");if(this.options.articleId||console.error("Missing required configuration option: `articleId`. Documentation on how to construct an instance of Comments is at https://registry.origami.ft.com/components/o-comments@7.7.3/readme#constructing-an-o-comments"),this.options.articleUrl||console.error("Missing required configuration option: `articleUrl`. Documentation on how to construct an instance of Comments is at https://registry.origami.ft.com/components/o-comments@7.7.3/readme#constructing-an-o-comments"),this.options.title||console.error("Missing required configuration option: `title`. Documentation on how to construct an instance of Comments is at https://registry.origami.ft.com/components/o-comments@7.7.3/readme#constructing-an-o-comments"),n){const e=new u(t,this.options);return e.renderCount(),e}{const e=new l(t,this.options);return e.init(),e}}static getCount(t){return u.fetchCount(t)}static getDataAttributes(t){return t instanceof HTMLElement?Object.keys(t.dataset).reduce((e,n)=>{if("oComponent"===n)return e;const o=n.replace(/^oComments(\w)(\w+)$/,(t,e,n)=>e.toLowerCase()+n),s=t.dataset[n];try{e[o]=JSON.parse(s.replace(/\'/g,'"'))}catch(t){e[o]=s}return e},{}):{}}static init(t,e){return t||(t=document.body),t instanceof HTMLElement||(t=document.querySelector(t)),t instanceof HTMLElement&&t.matches("[data-o-component=o-comments]")?new p(t,e):Array.from(t.querySelectorAll('[data-o-component="o-comments"]'),t=>new p(t,e))}}var h=p;const g=function(){h.init(),document.removeEventListener("o.DOMContentLoaded",g)};"undefined"!=typeof document&&document.addEventListener("o.DOMContentLoaded",g);e.default=h}}]);
//# sourceMappingURL=financial-times-o-comments.79af10951c8d.bundle.js.map