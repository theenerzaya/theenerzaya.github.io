(window.webpackJsonp=window.webpackJsonp||[]).push([["financial-times-o-video"],{"784525b2":function(e,t,i){"use strict";i.r(t);var s=i("3c85f3e3");const a={mpeg4:['video/mp4; codecs="mp4v.20.8"'],h264:['video/mp4; codecs="avc1.42E01E"','video/mp4; codecs="avc1.42E01E, mp4a.40.2"'],ogg:['video/ogg; codecs="theora"'],webm:['video/webm; codecs="vp8, vorbis"']};var o=function(){const e=document.createElement("video"),t=[];try{Object.keys(a).forEach(i=>{a[i].some(t=>e.canPlayType(t))&&t.push(i)})}catch(e){}return t};var n=function(e,t){const i=t||{},s=i.optimumvideowidth,a=i.supportedFormats||o();let n;const d=e.filter(e=>a.indexOf(e.codec.toLowerCase())>-1).sort((e,t)=>e.pixelWidth-t.pixelWidth);return s?(d.some(e=>e.pixelWidth>=s&&(n=e,!0)),n||d.pop()):d.pop()};let d=!1,r=null;var l=class{constructor(e){this.video=e,this.adsLoaded=!1,this.videoLoaded=!1,this.loadingStateDisplayed=!1,this.adsCompleted=!1}static loadAdsLibrary(){return new Promise((e,t)=>{let i=document.querySelector('[src="//imasdk.googleapis.com/js/sdkloader/ima3.js"]');i||(i=document.createElement("script"),i.setAttribute("type","text/javascript"),i.setAttribute("src","//imasdk.googleapis.com/js/sdkloader/ima3.js"),i.setAttribute("async",!0),i.setAttribute("defer",!0),document.getElementsByTagName("head")[0].appendChild(i)),d||window.google&&window.google.ima?e():r?t(r):(i.addEventListener("load",()=>{d=!0,e()}),i.addEventListener("error",e=>{r=e,t(e)}))})}getVideoBrand(){return!!(this.video.videoData&&this.video.videoData.brand&&this.video.videoData.brand.name)&&this.video.videoData.brand.name}setUpAds(){this.adContainerEl=document.createElement("div"),this.video.containerEl.appendChild(this.adContainerEl),this.adDisplayContainer=new google.ima.AdDisplayContainer(this.adContainerEl,this.video.videoEl),this.adsLoader=new google.ima.AdsLoader(this.adDisplayContainer),this.adsManagerLoadedHandler=this.adsManagerLoadedHandler.bind(this),this.adErrorHandler=this.adErrorHandler.bind(this),this.adEventHandler=this.adEventHandler.bind(this),this.contentPauseRequestHandler=this.contentPauseRequestHandler.bind(this),this.contentResumeRequestHandler=this.contentResumeRequestHandler.bind(this),this.getAdProgress=this.getAdProgress.bind(this),this.adsLoader.addEventListener(google.ima.AdsManagerLoadedEvent.Type.ADS_MANAGER_LOADED,this.adsManagerLoadedHandler,!1),this.adsLoader.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,this.adErrorHandler,!1),this.requestAds(),this.playAdEventHandler=this.playAdEventHandler.bind(this),this.video.opts.placeholder?this.playAdEventHandler():(this.overlayEl=function(){const e=document.createElement("div");return e.classList.add("o-video__overlay"),e}(),this.video.containerEl.appendChild(this.overlayEl),this.overlayEl.addEventListener("click",this.playAdEventHandler))}requestAds(){const e=new google.ima.AdsRequest;let t=`pos=${this.video.targeting.position}&ttid=${this.video.targeting.videoId}`;const i=this.getVideoBrand();i&&(t+="&brand="+i);const s=`http://pubads.g.doubleclick.net/gampad/ads?env=vp&gdfp_req=1&impl=s&output=xml_vast2&iu=${this.video.targeting.site}&sz=${this.video.targeting.sizes}&unviewed_position_start=1&scp=${encodeURIComponent(t)}`;e.adTagUrl=s,e.linearAdSlotWidth=592,e.linearAdSlotHeight=333,e.nonLinearAdSlotWidth=592,e.nonLinearAdSlotHeight=150;const a={detail:{category:"video",action:"adRequested",contentId:this.video.opts.id},bubbles:!0},o=new CustomEvent("oTracking.event",a);document.body.dispatchEvent(o),this.adsLoader.requestAds(e)}adsManagerLoadedHandler(e){const t=new google.ima.AdsRenderingSettings;t.restoreCustomPlaybackStateOnAdBreakComplete=!0,this.adsManager=e.getAdsManager(this.video.videoEl,t),this.adsManager.addEventListener(google.ima.AdErrorEvent.Type.AD_ERROR,this.adErrorHandler),this.adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_PAUSE_REQUESTED,this.contentPauseRequestHandler),this.adsManager.addEventListener(google.ima.AdEvent.Type.CONTENT_RESUME_REQUESTED,this.contentResumeRequestHandler),this.adsManager.addEventListener(google.ima.AdEvent.Type.ALL_ADS_COMPLETED,this.adEventHandler),this.adsManager.addEventListener(google.ima.AdEvent.Type.LOADED,this.adEventHandler),this.adsManager.addEventListener(google.ima.AdEvent.Type.STARTED,this.adEventHandler),this.adsManager.addEventListener(google.ima.AdEvent.Type.COMPLETE,this.adEventHandler),this.adsManager.addEventListener(google.ima.AdEvent.Type.SKIPPED,this.adEventHandler),this.adsManager.addEventListener(google.ima.AdEvent.Type.SKIPPABLE_STATE_CHANGED,this.adEventHandler),this.adsLoaded=!0,this.startAds()}startAds(){if(this.videoLoaded&&this.loadingStateDisplayed){if(this.video.opts.advertising){if(!this.adsLoaded)return}else this.playUserVideo();this.loadingStateEl&&(this.loadingStateEl.parentNode.removeChild(this.loadingStateEl),this.loadingStateEl=null);try{this.adsManager.init(this.video.videoEl.clientWidth,this.video.videoEl.clientHeight,google.ima.ViewMode.NORMAL),this.adsManager.start()}catch(e){this.reportError(e),this.playUserVideo()}}}playAdEventHandler(){this.adContainerEl.classList.add("o-video__ad"),this.adDisplayContainer.initialize(),this.loadingStateEl=document.createElement("span"),this.loadingStateEl.setAttribute("role","progressbar"),this.loadingStateEl.setAttribute("aria-valuetext","Loading"),this.loadingStateEl.className="o-video__loading-state",this.adContainerEl.appendChild(this.loadingStateEl),setTimeout(()=>{this.loadingStateDisplayed=!0,this.startAds()},2e3);const e=()=>{this.videoLoaded=!0,this.startAds(),this.video.videoEl.removeEventListener("loadedmetadata",e)};this.video.videoEl.addEventListener("loadedmetadata",e),this.video.videoEl.load(),this.overlayEl&&(this.overlayEl.removeEventListener("click",this.playAdEventHandler),this.video.containerEl.removeChild(this.overlayEl)),delete this.overlayEl}adEventHandler(e){const t=e.getAd(),i={detail:{advertising:!0,category:"video",contentId:this.video.opts.id,progress:0,adDuration:t.getDuration(),adMinDuration:t.getMinSuggestedDuration(),adTitle:t.getTitle(),adProgress:this.getAdProgress()},bubbles:!0};switch(e.type){case google.ima.AdEvent.Type.LOADED:t.isLinear()||this.playUserVideo();break;case google.ima.AdEvent.Type.STARTED:{i.detail.action="adStart";const e=new CustomEvent("oTracking.event",i);document.body.dispatchEvent(e),t.isLinear(),this.video.liveRegionEl.innerHTML=`Video will play after ad in ${i.detail.adDuration} seconds`;break}case google.ima.AdEvent.Type.COMPLETE:{i.detail.action="adComplete";const e=new CustomEvent("oTracking.event",i);document.body.dispatchEvent(e),t.isLinear(),this.video.liveRegionEl.innerHTML="";break}case google.ima.AdEvent.Type.SKIPPABLE_STATE_CHANGED:{i.detail.action="adSkippable";const e=new CustomEvent("oTracking.event",i);document.body.dispatchEvent(e);break}case google.ima.AdEvent.Type.SKIPPED:{i.detail.action="adSkip";const e=new CustomEvent("oTracking.event",i);document.body.dispatchEvent(e);break}case google.ima.AdEvent.Type.ALL_ADS_COMPLETED:{i.detail.action="allAdsCompleted";const e=new CustomEvent("oTracking.event",i);document.body.dispatchEvent(e);break}default:throw new Error("adEvent has type "+e.type+", which is not handled by adEventHandler")}}reportError(e){document.body.dispatchEvent(new CustomEvent("oErrors.log",{bubbles:!0,detail:{error:e}}))}adErrorHandler(e){const t="getError"in e&&"function"==typeof e.getError?e.getError():e,i=`${t.getErrorCode()}, ${t.getType()}, ${t.getMessage()}, ${t.getVastErrorCode()}`;this.reportError(new Error(i)),this.adsManager&&this.adsManager.destroy(),this.video.containerEl.removeChild(this.adContainerEl),this.overlayEl&&(this.overlayEl.removeEventListener("click",this.playAdEventHandler),this.video.containerEl.removeChild(this.overlayEl),delete this.overlayEl),this.video.placeholderEl&&this.video.placeholderEl.removeEventListener("click",this.playAdEventHandler),this.video.opts.advertising=!1,this.startAds()}contentPauseRequestHandler(){this.adsCompleted=!1,this.video.videoEl.pause()}contentResumeRequestHandler(){this.video.containerEl.removeChild(this.adContainerEl),this.adsCompleted=!0,this.playUserVideo()}playUserVideo(){this.video.addCaptions(),this.video.videoEl.play()}getAdProgress(){if(!this.adsManager||!this.adsManager.getCurrentAd())return 0;const e=this.adsManager.getCurrentAd().getDuration(),t=this.adsManager.getRemainingTime();return parseInt(100*(e-t)/e,10)}};var h=class{constructor(e){this.video=e,this.opts=this.video.opts.placeholderInfo.reduce((e,t)=>(e[t]=!0,e),{}),this.infoEl=document.createElement("div"),this.infoEl.className="o-video__info",this.opts.brand&&(this.brandEl=document.createElement("span"),this.brandEl.className="o-video__info-brand",this.infoEl.appendChild(this.brandEl)),this.opts.title&&(this.titleEl=document.createElement("span"),this.titleEl.className="o-video__info-title",this.infoEl.appendChild(this.titleEl)),this.opts.description&&(this.descriptionEl=document.createElement("p"),this.descriptionEl.className="o-video__info-description",this.infoEl.appendChild(this.descriptionEl)),this.update(),this.video.placeholderEl.appendChild(this.infoEl)}update(){if(this.brandEl){const e=this.video.videoData.brand&&this.video.videoData.brand.name;this.brandEl.textContent=e}this.titleEl&&(this.titleEl.textContent=this.video.videoData.title),this.descriptionEl&&(this.descriptionEl.textContent=this.video.videoData.standfirst)}teardown(){this.video.placeholderEl.removeChild(this.infoEl),delete this.infoEl,delete this.brandEl,delete this.titleEl,delete this.descriptionEl}};var c=class{constructor(e){this.opts=e;const t=e.player.videoData?e.player.videoData.id:e.player.opts.id;this.currentIndex=t?e.queue.indexOf(t.toString()):-1,this.cache={},this.opts.autoplay&&(this.opts.player.containerEl.addEventListener("ended",this.next.bind(this),!0),-1===this.currentIndex&&this.next())}next(){this.goto(this.currentIndex+1)}prev(){this.goto(this.currentIndex-1)}goto(e){e<0?this.currentIndex=this.opts.queue.length-1:e>=this.opts.queue.length?this.currentIndex=0:this.currentIndex=e;const t=this.opts.player.videoData&&this.opts.player.videoData.id;t&&!this.cache[t]&&(this.cache[t]=this.opts.player.videoData),this.opts.player.fireWatchedEvent(),this.opts.player.resetAmountWatched();const i=this.opts.queue[this.currentIndex],s={id:i,data:this.cache[i]};return this.opts.player.update(s).then(()=>{this.opts.player.videoEl&&this.opts.player.videoEl.play()})}};const p=e=>{const t=document.createElement("div");return t.className="o-video__guidance "+(e?"o-video__guidance--banner":""),t},v=()=>{const e=document.createElement("a");return e.setAttribute("href","https://www.ft.com/accessibility#video-transcriptions"),e.className="o-video__guidance__link",e.innerText="Subtitles unavailable",e.target="_blank",e.addEventListener("click",e=>e.stopPropagation()),e};var E=class{constructor(){this.removeBanner=this.removeBanner.bind(this),this.hideBanner=this.hideBanner.bind(this)}createPlaceholder(){const e=p();return e.appendChild(v()),e}createBanner(){return this.banner=p(!0),this.banner.appendChild((e=>{const t=document.createElement("button");return t.className="o-video__guidance__close",t.addEventListener("click",t=>{t.stopPropagation(),e()}),t})(this.removeBanner)),this.banner.appendChild(v()),this.timeout=setTimeout(this.hideBanner,5e3),this.banner}removeBanner(){this.banner&&(this.banner.remove(),clearTimeout(this.timeout))}hideBanner(){this.banner&&this.banner.classList.add("o-video__guidance--hidden")}};function u(e,t){e.opts.advertising&&e.videoAds&&e.videoAds.adsLoaded&&!e.videoAds.adsCompleted||("progress"!==t.type||function(e){const t=e.getProgress(),i=e.opts.id;m[i]||(m[i]=[]);if(![8,9,10,11,12,23,24,25,26,27,48,49,50,51,52,73,74,75,76,77,100].includes(t))return!1;if(m[i].includes(t))return!1;return m[i].push(t),!0}(e))&&g(t.type,e,{progress:e.getProgress(),duration:e.getDuration(),textTrackMode:e.getTrackMode()})}function g(e,t){let i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const s=new CustomEvent("oTracking.event",{detail:Object.assign({category:"video",action:e,advertising:t.opts.advertising,contentId:t.opts.id},i),bubbles:!0});document.body.dispatchEvent(s)}const m={};function y(){this.updateAmountWatched(),g("watched",this,{amount:this.getAmountWatched(0),amountPercentage:this.getAmountWatchedPercentage(0)})}function b(e){e.detail.hidden?this.updateAmountWatched():this.videoEl.paused||this.markPlayStart()}const A="onbeforeunload"in window?"beforeunload":"unload",C={advertising:!1,allProgress:!1,autorender:!0,classes:[],optimumwidth:null,placeholder:!1,placeholderInfo:["title"],placeholderHint:"",playsinline:!1,showCaptions:!0,showGuidance:!0,data:null};class f{constructor(e,t){if(this.containerEl=e,this.amountWatched=0,this.fireWatchedEvent=y.bind(this),this.visibilityListener=b.bind(this),this.didUserPressPlay=!1,this.opts=Object.assign({},C,t,function(e){const t={};return Array.prototype.forEach.call(e,e=>{if(0===e.name.indexOf("data-o-video")){const i=e.name.replace("data-o-video-","").replace(/-([a-z])/g,(e,t)=>t.toUpperCase());try{t[i]="placeholderInfo"===i?JSON.parse(e.value.replace(/\'/g,'"')):JSON.parse(e.value)}catch(s){t[i]=e.value}}}),t}(this.containerEl.attributes)),"string"!=typeof this.opts.systemcode)throw new Error('o-video requires "systemcode" is configured using the "data-o-video-systemcode" data attribute, or configured with the `opts` constructor argument. It must be set to a valid [Bizops system code](https://biz-ops.in.ft.com/list/Systems).');"string"==typeof this.opts.classes&&(this.opts.classes=this.opts.classes.split(" ")),-1===this.opts.classes.indexOf("o-video__video")&&this.opts.classes.push("o-video__video"),this.targeting={site:"/5887/ft.com",position:"video",sizes:"592x333|400x225",videoId:this.opts.id},this.opts.advertising&&(this.videoAds=new l(this)),this.containerEl.setAttribute("data-o-video-js",""),!0===this.opts.autorender&&this.init(),this.opts.showGuidance&&(this.guidance=new E)}getData(){return(this.opts.data?Promise.resolve(this.opts.data):fetch("https://next-media-api.ft.com/v1/"+this.opts.id).then(e=>{if(e.ok)return e.json();throw Error("Next Media API responded with a "+e.status+" ("+e.statusText+") for id "+this.opts.id)})).then(e=>{this.videoData=e,this.posterImage=e.mainImageUrl&&function(e,t,i){let s=`https://www.ft.com/__origami/service/image/v2/images/raw/${encodeURIComponent(e)}?source=${i}&quality=low`;return t&&(s+="&fit=scale-down&width="+t),s}(e.mainImageUrl,this.opts.optimumwidth,this.opts.systemcode),this.rendition=n(e.renditions,this.opts)})}renderVideo(){this.rendition&&(this.opts.placeholder?this.addPlaceholder():this.addVideo())}init(){return(this.opts.advertising?l.loadAdsLibrary():Promise.resolve()).catch(()=>{this.opts.advertising=!1}).then(()=>this.getData()).then(()=>this.renderVideo())}addVideo(){this.liveRegionEl=document.createElement("div"),this.liveRegionEl.setAttribute("aria-live","assertive"),this.liveRegionEl.classList.add("o-video__live-region"),this.videoEl=document.createElement("video"),this.videoEl.controls=!0,this.videoEl.className=Array.isArray(this.opts.classes)?this.opts.classes.join(" "):this.opts.classes,this.containerEl.classList.add("o-video--player"),this.opts.playsinline&&(this.videoEl.setAttribute("playsinline","true"),this.videoEl.setAttribute("webkit-playsinline","true")),this.videoEl.controlsList&&this.videoEl.controlsList.add("nodownload"),this.updateVideo(),this.placeholderEl&&!this.opts.advertising&&(this.videoEl.autoplay=this.videoEl.autostart=!0),this.containerEl.appendChild(this.liveRegionEl),this.containerEl.appendChild(this.videoEl),function(e,t){t.forEach(t=>{e.videoEl.addEventListener(t,u.bind(this,e))})}(this,["playing","pause","ended","progress","seeked","error","stalled","waiting"]),this.videoEl.addEventListener("playing",this.pauseOtherVideos.bind(this)),this.videoEl.addEventListener("playing",this.markPlayStart.bind(this)),this.videoEl.addEventListener("pause",this.updateAmountWatched.bind(this)),this.videoEl.addEventListener("suspend",this.clearCurrentlyPlaying.bind(this)),this.videoEl.addEventListener("ended",this.clearCurrentlyPlaying.bind(this)),this.opts.advertising&&this.videoAds.setUpAds(),window.addEventListener(A,this.fireWatchedEvent),s.default.listenTo("visibility"),window.addEventListener("oViewport.visibility",this.visibilityListener)}addCaptions(){if(!1===this.opts.showCaptions)return;if(void 0===this.videoData)throw new Error("Please call `getData()` before calling `addCaptions()` directly.");const e=this.videoEl.querySelector("track");if(e&&this.videoEl.removeChild(e),this.videoData.captionsUrl){const e=document.createElement("track");e.setAttribute("label","English"),e.setAttribute("kind","captions"),e.setAttribute("srclang","en"),e.setAttribute("src",this.videoData.captionsUrl),e.setAttribute("crossorigin","true"),this.videoEl.setAttribute("crossorigin","true"),this.videoEl.appendChild(e)}}updateVideo(){this.posterImage?this.videoEl.poster=this.posterImage:this.videoEl.removeAttribute("poster"),this.videoEl.src=this.rendition&&this.rendition.url,this.guidance&&this.guidance.removeBanner(),function(e,t,i){const s=function(){e.removeEventListener(t,s),i(...arguments)};e.addEventListener(t,s)}(this.videoEl,"playing",this.showGuidanceBanner.bind(this)),this.addCaptions()}addPlaceholder(){this.placeholderEl=document.createElement("div"),this.placeholderEl.className="o-video__placeholder",this.placeholderImageEl=document.createElement("img"),this.placeholderImageEl.className="o-video__placeholder-image",this.placeholderImageEl.setAttribute("role","presentation"),this.placeholderImageEl.setAttribute("alt",""),this.placeholderEl.appendChild(this.placeholderImageEl),this.opts.placeholderInfo.length&&(this.infoPanel=new h(this));const e=document.createElement("div");e.className="o-video__play-cta "+(this.opts.placeholderHint?"o-video__play-cta--with-hint":"o-video__play-cta--without-hint"),this.playButtonElContainer=document.createElement("div"),this.playButtonElContainer.className="o-video__play-button-container",this.playButtonEl=document.createElement("button"),this.playButtonEl.className="o-video__play-button",this.playButtonElContainer.appendChild(this.playButtonEl);const t=document.createElement("span");t.className="o-video__play-button-icon",t.textContent=this.opts.placeholderHint,e.appendChild(t);const{captionsUrl:i}=this.videoData||{};!i&&this.guidance&&this.playButtonElContainer.appendChild(this.guidance.createPlaceholder()),this.playButtonEl.appendChild(e),this.placeholderEl.appendChild(this.playButtonElContainer),this.placeholderEl.addEventListener("click",()=>{this.didUserPressPlay=!0,this.play()}),this.updatePlaceholder(),this.containerEl.appendChild(this.placeholderEl)}play(){this.placeholderEl?(this.addVideo(),this.videoEl.focus(),this.containerEl.removeChild(this.placeholderEl),this.infoPanel&&this.infoPanel.teardown(),delete this.placeholderEl,delete this.placeholderImageEl):this.videoEl.play()}updatePlaceholder(){this.posterImage&&(this.placeholderImageEl.src=this.posterImage),this.infoPanel&&this.infoPanel.update(),this.playButtonEl&&this.playButtonEl.setAttribute("aria-label","Play video "+this.videoData.title)}update(e){return this.videoEl&&this.videoEl.pause(),this.clearCurrentlyPlaying(),this.didUserPressPlay=!1,this.opts=Object.assign(this.opts,{data:null},e),this.videoEl||this.placeholderEl?this.getData().then(()=>{this.placeholderEl?this.updatePlaceholder():this.updateVideo()}):this.init()}getProgress(){return this.videoEl.duration?parseInt(100*this.videoEl.currentTime/this.videoEl.duration,10):0}getDuration(){return this.videoEl.duration?parseInt(this.videoEl.duration,10):0}getTrackMode(){return this.videoEl.textTracks&&this.videoEl.textTracks[0]?this.videoEl.textTracks[0].mode:void 0}getAmountWatched(e){const t=this.amountWatched/1e3;return void 0!==e?Number(t.toFixed(e)):t}getAmountWatchedPercentage(e){const t=this.videoEl&&this.videoEl.duration?100/this.videoEl.duration*this.getAmountWatched():0;return void 0!==e?Number(t.toFixed(e)):t}pauseOtherVideos(){this.currentlyPlayingVideo&&this.currentlyPlayingVideo!==this.videoEl&&this.currentlyPlayingVideo.pause(),this.currentlyPlayingVideo=this.videoEl}clearCurrentlyPlaying(){this.currentlyPlayingVideo!==this.videoEl&&(this.currentlyPlayingVideo=null)}markPlayStart(){this.playStart=Date.now()}updateAmountWatched(){void 0!==this.playStart&&(this.amountWatched+=Date.now()-this.playStart,this.playStart=void 0)}resetAmountWatched(){this.amountWatched=0}showGuidanceBanner(){const{captionsUrl:e}=this.videoData||{};this.didUserPressPlay||e||!this.guidance||this.containerEl.appendChild(this.guidance.createBanner())}destroy(){window.removeEventListener(A,this.fireWatchedEvent),window.removeEventListener("oViewport.visibility",this.visibilityListener)}static init(e,t){const i=[];e?"string"==typeof e&&(e=document.querySelector(e)):e=document.body;const s=e.querySelectorAll(':not([data-o-video-js])[data-o-component~="o-video"]');for(let e=0;e<s.length;e++)i.push(new f(s[e],t));return i}}f.Playlist=c;var L=f;const w=()=>{L.init(),document.removeEventListener("o.DOMContentLoaded",w)};"undefined"!=typeof document&&document.addEventListener("o.DOMContentLoaded",w);t.default=L}}]);
//# sourceMappingURL=financial-times-o-video.ec45fc1344bf.bundle.js.map